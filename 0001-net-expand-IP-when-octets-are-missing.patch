From fba5f8412d988899df7fa6564d04a47202eab4e5 Mon Sep 17 00:00:00 2001
From: Constantin Konstantinidis <constantinkonstantinidis@gmail.com>
Date: Sun, 8 Nov 2020 09:52:52 +0100
Subject: [PATCH] net: expand IP when octets are missing

Fixes #36822

Change-Id: I9104aada448eeb9173d3807ac1901b34cbed6010
---
 src/net/ip.go      | 13 ++++++++++---
 src/net/ip_test.go |  3 +++
 2 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/src/net/ip.go b/src/net/ip.go
index c00fe8ed3c..d0e69fb640 100644
--- a/src/net/ip.go
+++ b/src/net/ip.go
@@ -539,8 +539,15 @@ func parseIPv4(s string) IP {
 	var p [IPv4len]byte
 	for i := 0; i < IPv4len; i++ {
 		if len(s) == 0 {
-			// Missing octets.
-			return nil
+			if i == 0 {
+				return nil
+			}
+			// Shift values right
+			for j := 0; j < i; j++ {
+				p[IPv4len-j-1] = p[i-j-1]
+				p[i-j-1] = 0
+			}
+			break
 		}
 		if i > 0 {
 			if s[0] != '.' {
@@ -684,7 +691,7 @@ func ParseIP(s string) IP {
 			return parseIPv6(s)
 		}
 	}
-	return nil
+	return parseIPv4(s)
 }
 
 // parseIPZone parses s as an IP address, return it and its associated zone
diff --git a/src/net/ip_test.go b/src/net/ip_test.go
index a5fc5e644a..02af6c94d9 100644
--- a/src/net/ip_test.go
+++ b/src/net/ip_test.go
@@ -41,6 +41,9 @@ var parseIPTests = []struct {
 	{"fe80::1%lo0", nil},
 	{"fe80::1%911", nil},
 	{"", nil},
+	{"1", IPv4(0, 0, 0, 1)},
+	{"1.2", IPv4(0, 0, 1, 2)},
+	{"1.2.3", IPv4(0, 1, 2, 3)},
 	{"a1:a2:a3:a4::b1:b2:b3:b4", nil}, // Issue 6628
 }
 
-- 
2.28.0.windows.1

